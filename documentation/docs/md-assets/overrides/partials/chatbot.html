<style>
#chat-widget {
  position: fixed;
  bottom: 20px;
  right: 20px;
  width: 320px;
  background: #fff;
  border-radius: 12px;
  border: 1px solid #ddd;
  padding: 10px;
  box-shadow: 0 4px 20px rgba(0,0,0,0.2);
  font-family: sans-serif;
  z-index: 1000;
}
#chat-log {
  height: 200px;
  overflow-y: auto;
  margin-bottom: 10px;
  border: 1px solid #eee;
  border-radius: 4px;
  padding: 8px;
  background: #f9f9f9;
}
#chat-input {
  width: 100%;
  padding: 8px;
  border: 1px solid #ddd;
  border-radius: 4px;
  font-size: 14px;
}
</style>

<div id="chat-widget">
  <div id="chat-log"></div>
  <input id="chat-input" placeholder="Ask a question..." autocomplete="off" />
</div>

<!-- Load chatbot script -->
<script>
  // Inline the chatbot initialization
  async function sendMessageToBot(message) {
    try {
      const res = await fetch("http://localhost:8001/health", {
        method: "GET",
        headers: {
          "Accept": "application/json",
        }
      });

      if (!res.ok) {
        return `Server error: ${res.status}`;
      }

      let data;
      try {
        data = await res.json();
        return data.reply || JSON.stringify(data);
      } catch {
        const text = await res.text();
        return text;
      }

    } catch (err) {
      console.error("Chatbot fetch failed:", err);
      return "Failed to reach backend at http://localhost:8001/health";
    }
  }

  function escapeHtml(str) {
    return str
      .replaceAll("&", "&amp;")
      .replaceAll("<", "&lt;")
      .replaceAll(">", "&gt;")
      .replaceAll('"', "&quot;")
      .replaceAll("'", "&#039;");
  }

  function setupChat() {
    const input = document.getElementById("chat-input");
    const log = document.getElementById("chat-log");
    if (!input || !log) {
      console.warn("Chat elements not found");
      return;
    }

    input.addEventListener("keydown", async (e) => {
      if (e.key === "Enter") {
        e.preventDefault();
        const value = input.value.trim();
        if (!value) return;

        log.innerHTML += `<div><b>You:</b> ${escapeHtml(value)}</div>`;
        input.value = "";

        const typingId = `t${Date.now()}`;
        log.innerHTML += `<div id="${typingId}"><i>Bot is typingâ€¦</i></div>`;
        log.scrollTop = log.scrollHeight;

        const reply = await sendMessageToBot(value);

        const typingEl = document.getElementById(typingId);
        if (typingEl) typingEl.remove();

        log.innerHTML += `<div><b>Bot:</b> ${escapeHtml(reply)}</div>`;
        log.scrollTop = log.scrollHeight;
      }
    });
  }

  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", setupChat);
  } else {
    setupChat();
  }
</script>